const e=new WeakMap,t={createHTML:e=>e},r={anchor:'\na[href^="http"]:not([download]):not([target]),\na[href^="."]:not([download]):not([target]),\na[href^="/"]:not([download]):not([target])\n',form:"\nform:not([target])\n",focused:"\n:focus,\n:hover,\nbutton[type=submit],\nbutton:not([type])",className:"fetching",credentials:"same-origin",interval:1e3,redirect:"follow",retries:1/0,onContract:()=>{},onError:console.error},n=e=>e,{defaults:o,fetch:s,listen:a,on:c,parse:i,sse:l,trigger:u,when:h}=function({anchor:o=r.anchor,className:s=r.className,credentials:c=r.credentials,focused:l=r.focused,form:u=r.form,interval:h=r.interval,onContract:g=r.onContract,onError:w=r.onError,redirect:b=r.redirect,retries:y=r.retries,window:T}){const v={className:s,credentials:c,interval:h,onContract:g,onError:w,redirect:b,retries:y,window:T,contracts:[],promise:Promise.resolve(),url:T.location.href},L={defaults(){L.on(o,(e=>{L.listen("click",e,(t=>L.fetch(m(v,e),t,e).catch(w)))})),L.on(u,(e=>{L.listen("submit",e,(t=>(e.querySelectorAll(".error").forEach((e=>e.remove())),L.fetch(m(v,e),t,e).catch(w))))}))},async fetch(e,t,r=t&&t.target){const n={...d,event:t,request:e,target:r,session:v};if(!t)return n.fetch();if(t.defaultPrevented||t.cancelBubble)return;const o="submit"===t.type?r.querySelector(l):r;return t.preventDefault(),v.promise=v.promise.then((async()=>{o.classList.add(s),await n.fetch(),o.classList.remove(s)})),v.promise},listen(e,t,r,n={}){const o=f[e],s=Array.isArray(o)?o.listener.bind(t,r):r;return p("addEventListener",e,t,s,n),()=>p("removeEventListener",e,t,s,n)},on(e,t){v.contracts.push({listener:t,selector:e}),v.onContract(e,t)},parse(r,n){const o=globalThis.document.createElement("body");return o.classList.add("anticore"),o.id=n,o.innerHTML=function(r,n){n&&n.createPolicy&&!e.has(n)&&e.set(n,n.createPolicy("anticore",t));return(e.get(n)||t).createHTML(r)}(r,globalThis.trustedTypes),o},when(e,{url:t},r,o=n){const s=`${new URL(r,t)}`;return L.on(e,(async(e,t)=>{const r=await import(s);return o(r.default,r)(e,t)}))},sse(e,t,r=i){const n=new globalThis.EventSource(e,t);let o=!1;return a("beforeunload",globalThis,(()=>{o=!0}),{once:true,passive:true}),a("message",n,(t=>{L.trigger(r(t.data,e),e)}),{passive:true}),a("error",n,(e=>{o||w(e)}),{passive:true}),n},trigger:(e=v.window.document,t=v.window.document.location.href)=>({...d,session:v}.trigger(e,t).catch(w))};return L}({window:"undefined"!=typeof globalThis&&globalThis}),d={event:null,target:null,request:null,session:null,retries:null,async fetch(){const{request:e,session:t}=this,{window:r}=t;let n;try{const t=await r.fetch(e.clone()),{url:o=e.url}=t,s=await t.text();n=i(s,o),await this.trigger(n,o)}catch(e){const{interval:r,retries:o=t.retries}=this;if(n||!o)return Promise.reject(e);this.retries-=1,console.log(`Retrying in ${r/1e3}s`),await function(e){return new Promise((t=>setTimeout(t,e)))}(r),await this.fetch()}},async trigger(e,t){const r=[];return this.session.contracts.forEach((({selector:t,listener:n})=>{r.push(...[...e.querySelectorAll(t)].map((e=>t=>n(e,t))))})),Promise.all(r.map(g,{url:t}))}},f={};function p(e,t,r,n,o){const s=f[t]||[t],{length:a}=s;for(let t=0;t<a;t+=1){const a=s[t];`on${a}`in r&&r[e](a,n,o)}}async function g(e){const{url:t}=this;await e(t)}function m(e,t){const{window:r}=e,{Request:n}=r,{init:o,url:s}=function(e,t){const{credentials:r,redirect:n,window:o}=e,{FormData:s,Headers:a,URL:c,URLSearchParams:i}=o,{action:l,elements:u,href:h}=t,d=(t.method||"GET").toUpperCase(),f=!["GET","HEAD"].includes(d),p=new c(l||h||t.ownerDocument.location.href);if(u&&!f){const e=[p.search,new s(t)].filter(w);p.search=new i(e.join("&")).toString()}return{init:{...f&&{body:new s(t)},credentials:r,headers:new a({"X-Requested-With":"XMLHttpRequest"}),method:d,redirect:n},url:p.toString()}}(e,t);return new n(s,o)}function w(e){return e.toString().length}f.blur=["blur","touchcancel","touchleave"],f.blur.listener=function(e,t){return e.call(this,t)},f.click=["click","touchend"],f.click.listener=function(e,t){if(!t.touches||1===t.touches.length)return e.call(this,t)},f.focus=["focus","touchstart"],f.focus.listener=f.blur.listener,h("form input, form select, form textarea",{url:new URL("/assets/js/contracts/generics.js",globalThis.location).href},"../generics/highlight.js"),h("body:not(.anticore) [data-sse]",{url:new URL("/assets/js/contracts/generics.js",globalThis.location).href},"../generics/sse.js"),o(),h("main.congrats",{url:new URL("/assets/js/contracts/views.js",globalThis.location).href},"../views/congrats.js");c(".anticore > [data-before], .anticore > [data-after], .anticore > [data-prepend], .anticore > [data-append], .anticore > [data-replace]",(e=>{const{dataset:t,ownerDocument:r}=e,{after:n,append:o,before:s,prepend:a,replace:c}=t,[i]=[n,o,s,a,c].filter(Boolean),l=new Map([[n,"after"],[o,"append"],[s,"before"],[a,"prepend"],[c,"replaceWith"]]).get(i);r.querySelector(i)?.[l](e)}));const b=new WeakMap,{history:y}=globalThis,T=({outerHTML:e})=>e,v=e=>{const{name:t,nodeName:r,property:n,ownerDocument:o}=e,s=r.toLowerCase(),a="meta"!==s?s:`${s}[${t?"name":"property"}="${t||n}"]`;o.querySelector(a).replaceWith(e)};a("popstate",globalThis,(({state:e})=>{const t=i(e,globalThis.document.location.href);b.set(t,!0),u(t)}));c("main",((e,t)=>{const{ownerDocument:r}=e,n=e.getRootNode(),o=e.closest("body"),s=n.querySelector("title"),a=[s,...n.querySelectorAll("meta[name], meta[property]"),e],c=[a.map(T).join(""),s.innerHTML,t];r.contains(e)?y.replaceState(...c):(a.forEach(v),b.has(o)&&e.classList.contains("error")||y.pushState(...c),globalThis.location.hash||globalThis.scrollTo(0,0))})),u();export{r as config,o as defaults,s as fetch,a as listen,c as on,i as parse,l as sse,u as trigger,h as when};
